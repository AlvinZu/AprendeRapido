<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Educativo</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- === App Icons === -->
    <!-- iOS Icon -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/8B5CF6/FFFFFF?text=Q">
    
    <!-- Web App Manifest (with Android Icons) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUXVpeiBFZHVjYXRpdm8iLCJzaG9ydF9uYW1lIjoiUXVpeiBFZHUiLCJkZXNjcmlwdGlvbiI6IlByYWN0aWNhIG1hdGVtw6F0aWNhcyBlIGluZ2zDqXMgZGUgZm9ybWEgZGl2ZXJ0aWRhLiIsImljb25zIjpbeyJzcmMiOiJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzhCNUNGNi9GRkZGRkY/dGV4dD1RIiwidHlwZSI6ImltYWdlL3BuZyIsInNpemVzIjoiMTkyeDE5MiJ9LHsic3JjIjoiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi84QjVDRjYvRkZGRkZGP3RleHQ9USIsInR5cGUiOiJpbWFnZS9wbmciLCJzaXplcyI6IjUxMng1MTIifV0sInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjRjNGNEY2IiwidGhlbWVfY29sb3IiOiIjNEI1RUYzIn0=">
    <meta name="theme-color" content="#4B5563">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            max-width: 500px;
            width: 90%;
        }
        .btn-answer.correct {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
            transform: scale(1.05);
        }
        .btn-answer.incorrect {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        .btn-answer:disabled { opacity: 0.8; }
        #timer-progress {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
        /* Fade-in animation for screens */
        .screen-fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Karaoke style highlight */
        .reading-highlight {
            background-color: #fde047; /* yellow-300 */
            border-radius: 3px;
            padding: 0 2px;
        }
        /* Drag and Drop styles */
        .draggable-item {
            touch-action: none;
            cursor: grab;
        }
        .drop-target {
            transition: background-color 0.2s;
        }
        .drop-target.over {
            background-color: #dbeafe; /* blue-100 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="main-container text-center bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        
        <!-- Name Input Screen -->
        <div id="name-input-screen">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-4">¬°Bienvenido/a!</h1>
            <p class="text-gray-600 mb-6">Para empezar, por favor ingresa tu nombre.</p>
            <input type="text" id="name-input" placeholder="Escribe tu nombre aqu√≠" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="start-with-name-btn" class="w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Continuar</button>
        </div>

        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="hidden">
            <h1 id="welcome-title" class="text-3xl sm:text-4xl font-bold text-gray-700 mb-2"></h1>
            <p class="text-gray-600 mb-8">¬øListo para entrenar tu mente? Elige una materia.</p>
            <div class="space-y-4">
                 <button id="math-menu-btn" class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Matem√°ticas</button>
                 <button id="spanish-menu-btn" class="w-full bg-gradient-to-br from-amber-500 to-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Espa√±ol</button>
                 <button id="english-menu-btn" data-quiz-type="english" class="w-full bg-gradient-to-br from-purple-500 to-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Ingl√©s</button>
                 <button id="gems-menu-btn" class="w-full bg-gradient-to-br from-gray-400 to-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Mis Recompensas</button>
                 <button id="stats-menu-btn" class="w-full bg-gradient-to-br from-cyan-400 to-sky-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Mis Estad√≠sticas</button>
            </div>
        </div>
        
        <!-- Gems Screen -->
        <div id="gems-screen" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-6">Mis Recompensas</h1>
            <div id="gems-container" class="space-y-4 text-left p-4 bg-gray-50 rounded-lg">
                <!-- Gem details will be populated here -->
            </div>
            <p class="text-gray-500 mt-4 text-sm">¬°Consigue un üíé de cada nivel para el gran premio!</p>
            <button id="back-to-main-from-gems-btn" class="mt-8 text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver al Men√∫ Principal</button>
        </div>
        
        <!-- Stats Screen -->
        <div id="stats-screen" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-6">Mis Estad√≠sticas</h1>
            <div id="stats-container" class="space-y-6 text-left">
                <!-- Stats will be populated here -->
            </div>
            <button id="back-to-main-from-stats-btn" class="mt-8 text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver al Men√∫ Principal</button>
        </div>

        <!-- Grand Prize Alert Screen -->
        <div id="prize-alert-screen" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl transform transition-all scale-95 animate-pulse">
                <h2 class="text-4xl font-bold text-yellow-500 mb-4">¬°GRAN PREMIO!</h2>
                <p class="text-2xl text-gray-700 mb-6">¬°Felicidades, <span class="user-name-placeholder"></span>! Has demostrado tu maestr√≠a al conseguir diamantes de todos los niveles.</p>
                <p class="text-lg text-gray-600">¬°Te has ganado una tarjeta de Google Play para disfrutar de tus videojuegos favoritos como recompensa por tu incre√≠ble esfuerzo!</p>
                <button id="close-prize-alert-btn" class="mt-8 w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">¬°Genial!</button>
            </div>
        </div>

        <!-- Math Type Selection Screen -->
        <div id="math-type-screen" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-4">Matem√°ticas</h1>
            <p class="text-gray-600 mb-8">Elige un tipo de ejercicio.</p>
            <div class="space-y-4">
                 <button data-quiz-type="multiplication" class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Tablas de Multiplicar</button>
                 <button data-quiz-type="addition" class="w-full bg-gradient-to-br from-blue-500 to-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Sumas</button>
                 <button data-quiz-type="subtraction" class="w-full bg-gradient-to-br from-teal-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Restas</button>
                 <button data-quiz-type="division" class="w-full bg-gradient-to-br from-red-500 to-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Divisiones</button>
            </div>
            <button id="back-to-main-menu-btn" class="mt-8 text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver al Men√∫ Principal</button>
        </div>
        
        <!-- Spanish Type Selection Screen -->
        <div id="spanish-type-screen" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700 mb-4">Espa√±ol</h1>
            <p class="text-gray-600 mb-8">Elige un tipo de ejercicio.</p>
            <div class="space-y-4">
                 <button data-quiz-type="reading" class="w-full bg-gradient-to-br from-amber-500 to-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Lectura de Comprensi√≥n</button>
            </div>
            <button id="back-to-main-menu-btn-2" class="mt-8 text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver al Men√∫ Principal</button>
        </div>

        <!-- Difficulty Screen -->
        <div id="difficulty-screen" class="hidden">
            <h1 id="difficulty-title" class="text-3xl sm:text-4xl font-bold text-gray-700 mb-4"></h1>
            <p class="text-gray-600 mb-8">Selecciona un nivel de dificultad</p>
            <div id="difficulty-buttons-container" class="space-y-4">
                 <!-- Buttons are added dynamically -->
            </div>
             <button id="back-btn" class="mt-8 text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver</button>
        </div>

        <!-- Division Visual Game Screen -->
        <div id="division-visual-screen" class="hidden">
             <div class="flex justify-between items-center mb-4">
                <button id="back-from-division-game-btn" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Salir</button>
                <span id="division-game-counter" class="text-gray-600 font-semibold"></span>
            </div>
            <h2 id="division-game-title" class="text-2xl font-bold text-gray-800 mb-4">¬°A repartir!</h2>
            <p id="division-game-instruction" class="text-lg text-gray-600 mb-4"></p>
            <div id="items-source-container" class="h-24 p-2 border-2 border-dashed rounded-lg flex flex-wrap justify-center items-center gap-2 mb-4"></div>
            <div id="drop-targets-container" class="grid grid-cols-4 gap-4 mb-4"></div>
            <div id="division-game-feedback" class="h-8 text-xl font-bold mb-4"></div>
            <button id="check-division-btn" class="w-full bg-gradient-to-br from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Revisar</button>
        </div>
        
        <!-- Reading Screen -->
        <div id="reading-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button id="back-from-reading-btn" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Volver</button>
                <div class="w-12"></div> <!-- Spacer -->
            </div>
            <h1 id="reading-title" class="text-2xl font-bold text-gray-800 mb-4 -mt-6"></h1>
            <div id="reading-text-container" class="text-left text-lg text-gray-700 h-64 overflow-y-auto p-4 border rounded-lg bg-gray-50 mb-4"></div>
            <div id="reading-timer-container" class="text-lg font-semibold text-gray-600 mb-4">Tiempo de lectura: <span id="reading-timer"></span></div>
            <div id="reading-controls-container" class="space-y-3">
                <button id="start-reading-btn" class="w-full bg-gradient-to-br from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Empezar a Leer</button>
                <button id="pause-resume-btn" class="hidden w-full bg-gradient-to-br from-yellow-500 to-amber-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">Pausar</button>
            </div>
        </div>
        
        <!-- Round Transition Screen -->
        <div id="round-transition-screen" class="hidden">
            <h2 id="round-end-title" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p id="round-score" class="text-xl text-gray-600 mb-6"></p>
            <div class="space-y-3">
                <button id="next-round-btn" class="w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                    Siguiente Ronda
                </button>
                <button id="exit-session-btn" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300">
                    Salir al Men√∫
                </button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 text-gray-600 font-semibold">
                <button id="back-from-quiz-btn" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">‚Üê Salir</button>
                <span id="question-counter"></span>
                <span id="score">Puntaje: 0</span>
            </div>
            <div id="timer-container" class="relative w-24 h-24 mx-auto mb-4">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="timer-progress" class="text-indigo-600" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <span id="timer-text" class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-3xl font-bold text-gray-800"></span>
            </div>
            <div id="question-container" class="mb-8">
                <p id="question-text" class="text-2xl sm:text-4xl font-bold text-gray-800 h-16 flex items-center justify-center"></p>
            </div>
            <div id="answers-container" class="grid grid-cols-2 gap-4"></div>
            <div id="feedback-container" class="mt-6 h-8 text-xl font-bold"></div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden">
            <h2 id="final-title" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p id="final-score" class="text-xl text-gray-600 mb-2"></p>
            <p id="final-motivation" class="text-lg text-gray-500 mb-4"></p>
            <p id="summary-text" class="text-sm text-gray-400 mb-6"></p>
            <button id="restart-btn" class="w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                Jugar de Nuevo
            </button>
        </div>
    </div>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            const serviceWorkerCode = `
                const CACHE_NAME = 'math-spanish-quiz-cache-v13';
                const urlsToCache = ['/'];
                self.addEventListener('install', event => {
                    event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    self.skipWaiting();
                });
                self.addEventListener('fetch', event => {
                    if (event.request.mode === 'navigate') {
                        event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
                    }
                });
            `;
            const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err));
            });
        }

        // --- DOM Elements ---
        const screens = {
            nameInput: document.getElementById('name-input-screen'),
            mainMenu: document.getElementById('main-menu-screen'),
            gems: document.getElementById('gems-screen'),
            stats: document.getElementById('stats-screen'),
            prizeAlert: document.getElementById('prize-alert-screen'),
            mathType: document.getElementById('math-type-screen'),
            spanishType: document.getElementById('spanish-type-screen'),
            difficulty: document.getElementById('difficulty-screen'),
            divisionVisual: document.getElementById('division-visual-screen'),
            reading: document.getElementById('reading-screen'),
            quiz: document.getElementById('quiz-screen'),
            roundTransition: document.getElementById('round-transition-screen'),
            end: document.getElementById('end-screen')
        };
        const nameInputEl = document.getElementById('name-input');
        const startWithNameBtn = document.getElementById('start-with-name-btn');
        const welcomeTitleEl = document.getElementById('welcome-title');
        const mathMenuBtn = document.getElementById('math-menu-btn');
        const spanishMenuBtn = document.getElementById('spanish-menu-btn');
        const englishMenuBtn = document.getElementById('english-menu-btn');
        const gemsMenuBtn = document.getElementById('gems-menu-btn');
        const statsMenuBtn = document.getElementById('stats-menu-btn');
        const backToMainFromGemsBtn = document.getElementById('back-to-main-from-gems-btn');
        const backToMainFromStatsBtn = document.getElementById('back-to-main-from-stats-btn');
        const gemsContainerEl = document.getElementById('gems-container');
        const statsContainerEl = document.getElementById('stats-container');
        const closePrizeAlertBtn = document.getElementById('close-prize-alert-btn');
        const mathTypeButtons = screens.mathType.querySelectorAll('[data-quiz-type]');
        const spanishTypeButtons = screens.spanishType.querySelectorAll('[data-quiz-type]');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');
        const backToMainMenuBtn2 = document.getElementById('back-to-main-menu-btn-2');
        const difficultyTitle = document.getElementById('difficulty-title');
        const difficultyButtonsContainer = document.getElementById('difficulty-buttons-container');
        const backBtn = document.getElementById('back-btn');
        const backFromReadingBtn = document.getElementById('back-from-reading-btn');
        const backFromQuizBtn = document.getElementById('back-from-quiz-btn');
        const backFromDivisionGameBtn = document.getElementById('back-from-division-game-btn');
        const readingTitleEl = document.getElementById('reading-title');
        const readingTextContainerEl = document.getElementById('reading-text-container');
        const readingTimerEl = document.getElementById('reading-timer');
        const startReadingBtn = document.getElementById('start-reading-btn');
        const pauseResumeBtn = document.getElementById('pause-resume-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const exitSessionBtn = document.getElementById('exit-session-btn');
        const restartBtn = document.getElementById('restart-btn');
        const questionCounterEl = document.getElementById('question-counter');
        const scoreEl = document.getElementById('score');
        const questionTextEl = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const roundEndTitleEl = document.getElementById('round-end-title');
        const roundScoreEl = document.getElementById('round-score');
        const finalTitleEl = document.getElementById('final-title');
        const finalScoreEl = document.getElementById('final-score');
        const finalMotivationEl = document.getElementById('final-motivation');
        const summaryTextEl = document.getElementById('summary-text');
        const timerProgress = document.getElementById('timer-progress');
        const timerText = document.getElementById('timer-text');
        const divisionGameCounterEl = document.getElementById('division-game-counter');
        const divisionGameInstructionEl = document.getElementById('division-game-instruction');
        const itemsSourceContainerEl = document.getElementById('items-source-container');
        const dropTargetsContainerEl = document.getElementById('drop-targets-container');
        const divisionGameFeedbackEl = document.getElementById('division-game-feedback');
        const checkDivisionBtn = document.getElementById('check-division-btn');

        // --- Content Data ---
        const englishData = {
            colors: {
                'Rojo': 'Red', 'Azul': 'Blue', 'Verde': 'Green', 'Amarillo': 'Yellow', 'Naranja': 'Orange', 'Morado': 'Purple', 'Negro': 'Black', 'Blanco': 'White', 'Rosa': 'Pink', 'Marr√≥n': 'Brown', 'Gris': 'Gray', 'Cian': 'Cyan', 'Dorado': 'Gold', 'Plateado': 'Silver', 'Turquesa': 'Turquoise',
                'Beige': 'Beige', '√çndigo': 'Indigo', 'Violeta': 'Violet', 'Magenta': 'Magenta', 'Lima': 'Lime', 'Oliva': 'Olive', 'Carmes√≠': 'Crimson', 'Caqui': 'Khaki', 'Marfil': 'Ivory', 'Lavanda': 'Lavender', 'Salm√≥n': 'Salmon', 'Cobre': 'Copper', 'Bronce': 'Bronze', 'Esmeralda': 'Emerald', 'Rub√≠': 'Ruby'
            },
            animals: {
                'Perro': 'Dog', 'Gato': 'Cat', 'P√°jaro': 'Bird', 'Pez': 'Fish', 'Caballo': 'Horse', 'Vaca': 'Cow', 'Le√≥n': 'Lion', 'Tigre': 'Tiger', 'Oso': 'Bear', 'Elefante': 'Elephant', 'Serpiente': 'Snake', 'Mono': 'Monkey', 'Jirafa': 'Giraffe', 'Cebra': 'Zebra', 'Lobo': 'Wolf', 'Zorro': 'Fox', 'Pato': 'Duck', 'Rana': 'Frog',
                'Conejo': 'Rabbit', 'Cerdo': 'Pig', 'Oveja': 'Sheep', 'Pollo': 'Chicken', 'Rat√≥n': 'Mouse', 'Tibur√≥n': 'Shark', 'Ballena': 'Whale', 'Delf√≠n': 'Dolphin', 'Cangrejo': 'Crab', 'Pulpo': 'Octopus', '√Åguila': 'Eagle', 'B√∫ho': 'Owl', 'Mariposa': 'Butterfly'
            },
            verbs: {
                'Correr': 'Run', 'Comer': 'Eat', 'Beber': 'Drink', 'Dormir': 'Sleep', 'Jugar': 'Play', 'Leer': 'Read', 'Escribir': 'Write', 'Caminar': 'Walk', 'Hablar': 'Speak', 'Ver': 'See', 'Nadar': 'Swim', 'Volar': 'Fly', 'Cantar': 'Sing', 'Bailar': 'Dance', 'Pensar': 'Think', 'Aprender': 'Learn', 'Ayudar': 'Help', 'Mirar': 'Look', 'Escuchar': 'Listen',
                'Trabajar': 'Work', 'Abrir': 'Open', 'Cerrar': 'Close', 'Dar': 'Give', 'Tomar': 'Take', 'Querer': 'Want', 'Saber': 'Know', 'Ir': 'Go', 'Venir': 'Come', 'Hacer': 'Do', 'Decir': 'Say', 'Obtener': 'Get', 'Crear': 'Make', 'Encontrar': 'Find'
            }
        };
        const readingData = [
            {
                title: 'El Universo Creativo de Roblox',
                text: 'Roblox no es solo un juego, es una plataforma gigante donde millones de personas crean y comparten sus propias aventuras. Desde su lanzamiento, ha permitido a los jugadores convertirse en desarrolladores, usando herramientas sencillas para construir mundos enteros. Cada d√≠a, se publican miles de juegos nuevos, conocidos como "experiencias". Esto significa que siempre hay algo nuevo que descubrir, ya sea un juego de rol, una carrera de obst√°culos o una simulaci√≥n de vida. La moneda virtual del juego, llamada Robux, se puede ganar o comprar para personalizar avatares y obtener ventajas en las experiencias.',
                wpm: 100,
                questions: [
                    { q: '¬øQu√© es Roblox principalmente?', a: 'Una plataforma para crear juegos', o: ['Una pel√≠cula', 'Una red social', 'Una tienda de ropa'] },
                    { q: '¬øC√≥mo se llaman los juegos dentro de Roblox?', a: 'Experiencias', o: ['Niveles', 'Mundos', 'Mapas'] },
                    { q: '¬øCu√°l es el nombre de la moneda virtual de Roblox?', a: 'Robux', o: ['Puntos', 'Monedas', 'Gemas'] }
                ]
            },
            {
                title: 'Free Fire y su Estrategia de Supervivencia',
                text: 'Free Fire es un popular juego de "battle royale" para m√≥viles donde 50 jugadores caen en una isla y luchan hasta que solo uno queda en pie. La clave del √©xito no es solo disparar, sino tambi√©n la estrategia. Los jugadores deben encontrar armas y equipo r√°pidamente, mientras se mueven hacia la "zona segura", un √°rea que se va haciendo m√°s peque√±a con el tiempo. El juego es famoso por sus personajes, cada uno con habilidades especiales que pueden cambiar el rumbo de una partida. Adem√°s, las colaboraciones con artistas y marcas famosas, como J Balvin o McLaren, traen eventos y skins exclusivas que mantienen el juego siempre fresco e interesante.',
                wpm: 110,
                questions: [
                    { q: '¬øCu√°ntos jugadores participan en una partida de Free Fire?', a: '50', o: ['100', '25', '75'] },
                    { q: '¬øQu√© es la "zona segura"?', a: 'Un √°rea que se hace m√°s peque√±a', o: ['Un lugar para esconderse', 'Una tienda de armas', 'El punto de inicio'] },
                    { q: '¬øQu√© hace que los personajes de Free Fire sean especiales?', a: 'Tienen habilidades √∫nicas', o: ['Son invisibles', 'Pueden volar', 'No necesitan armas'] }
                ]
            },
            {
                title: 'Warzone: T√°cticas en el Campo de Batalla',
                text: 'Call of Duty: Warzone es un juego de disparos masivo que combina la acci√≥n r√°pida de Call of Duty con la estrategia de un "battle royale". A diferencia de otros juegos, si un jugador es eliminado, tiene una segunda oportunidad en el "Gulag", un duelo 1 contra 1 donde el ganador puede volver a la partida. Warzone tambi√©n destaca por su sistema de "loadouts", que permite a los jugadores pedir sus armas y ventajas personalizadas durante el juego. Los mapas son enormes y detallados, basados en lugares ic√≥nicos de la saga, lo que obliga a los equipos a comunicarse y planificar sus movimientos para controlar zonas clave y asegurar la victoria.',
                wpm: 115,
                questions: [
                    { q: '¬øQu√© es el "Gulag" en Warzone?', a: 'Una segunda oportunidad para volver', o: ['La prisi√≥n final', 'Una tienda de armas', 'Un veh√≠culo especial'] },
                    { q: '¬øQu√© son los "loadouts"?', a: 'Armas personalizadas que se piden', o: ['Mapas secretos', 'Tipos de soldados', 'Misiones secundarias'] },
                    { q: '¬øQu√© es crucial para la victoria en Warzone?', a: 'La comunicaci√≥n y planificaci√≥n', o: ['Correr sin parar', 'Esconderse siempre', 'Usar solo un tipo de arma'] }
                ]
            },
            {
                title: 'Fortnite: M√°s que un Battle Royale',
                text: 'Fortnite ha revolucionado el mundo de los videojuegos con sus famosas "temporadas". Cada pocos meses, el juego cambia por completo, introduciendo un nuevo tema, personajes y cambios en el mapa. Pero lo m√°s incre√≠ble son sus eventos en vivo. Millones de jugadores se han conectado al mismo tiempo para ver conciertos de artistas como Travis Scott y Ariana Grande, o para participar en eventos que cambian la historia del juego para siempre. Adem√°s del modo de batalla, existe el "Modo Creativo", donde los jugadores pueden construir sus propias islas y juegos, demostrando que Fortnite es tambi√©n una poderosa herramienta de creatividad.',
                wpm: 110,
                questions: [
                    { q: '¬øQu√© cambia en Fortnite con cada temporada?', a: 'El tema y el mapa', o: ['Las reglas del juego', 'El precio del juego', 'Los controles'] },
                    { q: '¬øQu√© tipo de eventos en vivo ha tenido Fortnite?', a: 'Conciertos de artistas famosos', o: ['Competencias de cocina', 'Carreras de autos reales', 'Obras de teatro'] },
                    { q: '¬øQu√© permite hacer el "Modo Creativo"?', a: 'Construir islas y juegos propios', o: ['Ver pel√≠culas', 'Chatear con amigos', 'Comprar ropa virtual'] }
                ]
            },
            {
                title: 'Minecraft: Construyendo tu Propia Aventura',
                text: 'Minecraft es un juego √∫nico que celebra la creatividad y la supervivencia. En su modo "Supervivencia", los jugadores deben explorar el mundo, recolectar recursos como madera y piedra, y construir un refugio para protegerse de los monstruos que aparecen de noche. Por otro lado, el modo "Creativo" ofrece recursos ilimitados, permitiendo a los jugadores construir cualquier cosa que puedan imaginar sin preocuparse por los peligros. Grandes actualizaciones, como la de "Caves & Cliffs", han a√±adido nuevas cuevas y monta√±as, haciendo la exploraci√≥n a√∫n m√°s emocionante. Minecraft demuestra que los l√≠mites solo est√°n en tu imaginaci√≥n.',
                wpm: 105,
                questions: [
                    { q: '¬øCu√°l es el objetivo principal en el modo "Supervivencia"?', a: 'Protegerse de los monstruos', o: ['Ganar carreras', 'Resolver acertijos', 'Volar por el mapa'] },
                    { q: '¬øQu√© ofrece el modo "Creativo"?', a: 'Recursos ilimitados para construir', o: ['Misiones dif√≠ciles', 'Monstruos m√°s fuertes', 'Tiempo limitado'] },
                    { q: '¬øQu√© a√±adi√≥ la actualizaci√≥n "Caves & Cliffs"?', a: 'Nuevas cuevas y monta√±as', o: ['Nuevos planetas', 'Coches y aviones', 'Nuevos personajes'] }
                ]
            },
            {
                title: 'La Vida sin Fin de GTA Online',
                text: 'Grand Theft Auto V es famoso por su incre√≠ble modo multijugador, GTA Online. En este modo, los jugadores crean su propio personaje y exploran la ciudad de Los Santos junto a otras personas de todo el mundo. Lo que hace a GTA Online tan especial es su constante evoluci√≥n. A lo largo de los a√±os, se han a√±adido innumerables actualizaciones gratuitas con nuevos veh√≠culos, misiones, negocios y atracos espectaculares. Los jugadores pueden convertirse en directores de un club nocturno, contrabandistas de armas o participar en carreras callejeras. Esta variedad de actividades ha mantenido al juego popular durante m√°s de una d√©cada, creando una comunidad muy activa.',
                wpm: 120,
                questions: [
                    { q: '¬øEn qu√© ciudad se desarrolla GTA Online?', a: 'Los Santos', o: ['Liberty City', 'Vice City', 'San Fierro'] },
                    { q: '¬øQu√© ha mantenido popular a GTA Online por tanto tiempo?', a: 'Sus constantes actualizaciones gratuitas', o: ['Que es un juego f√°cil', 'Que no tiene misiones', 'Que solo se puede jugar solo'] },
                    { q: '¬øQu√© es una de las actividades que se pueden hacer en el juego?', a: 'Dirigir un club nocturno', o: ['Construir casas', 'Adoptar mascotas', 'Ir a la escuela'] }
                ]
            }
        ];

        // --- Quiz Settings ---
        const quizSettings = {
            multiplication: { name: 'Tablas de Multiplicar', difficulties: { easy: { name: 'F√°cil', tables: { min: 2, max: 5 }, timeLimit: 15, optionLogic: 'wide' }, normal: { name: 'Normal', tables: { min: 2, max: 9 }, timeLimit: 10, optionLogic: 'plausible' }, hard: { name: 'Dif√≠cil', tables: { min: 2, max: 9 }, timeLimit: 7, optionLogic: 'close' }}},
            addition: { name: 'Sumas', difficulties: { easy: { name: 'F√°cil', range: [1, 9], timeLimit: 15, optionLogic: 'wide' }, normal: { name: 'Normal', range: [10, 99], timeLimit: 12, optionLogic: 'plausible' }, hard: { name: 'Dif√≠cil', range: [100, 999], timeLimit: 10, optionLogic: 'close' }}},
            subtraction: { name: 'Restas', difficulties: { easy: { name: 'F√°cil', range: [1, 9], timeLimit: 15, optionLogic: 'wide' }, normal: { name: 'Normal', range: [10, 99], timeLimit: 12, optionLogic: 'plausible' }, hard: { name: 'Dif√≠cil', range: [50, 200], timeLimit: 8, optionLogic: 'close' }}},
            division: { name: 'Divisiones', difficulties: { easy: { name: 'F√°cil (Visual)' }, normal: { name: 'Normal (Inversa de x)', timeLimit: 15 }, hard: { name: 'Dif√≠cil (con Resto)', timeLimit: 20 }}},
            english: { name: 'Ingl√©s', difficulties: { easy: { name: 'F√°cil (Colores)', timeLimit: 15, optionLogic: 'plausible', data: englishData.colors }, normal: { name: 'Normal (Animales)', timeLimit: 12, optionLogic: 'plausible', data: englishData.animals }, hard: { name: 'Dif√≠cil (Verbos)', timeLimit: 10, optionLogic: 'close', data: englishData.verbs }}},
            reading: { name: 'Lectura de Comprensi√≥n' }
        };
        
        // --- Quiz State ---
        let userName = '';
        let currentQuizType;
        let difficultySettings;
        let questions = [];
        let sessionContent = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalScore = 0;
        let currentRound = 1;
        let TOTAL_ROUNDS = 3;
        let QUESTIONS_PER_ROUND = 10;
        let timer;
        let readingTimerInterval;
        let karaokeInterval;
        let isReadingPaused = false;
        let timeLeft;
        let draggedItem = null;
        let gems = {};
        let stats = {};
        let englishVoice = null;

        // --- Gesture State ---
        let touchStartX = 0;
        let touchEndX = 0;

        const FULL_DASH_ARRAY = 283;

        // --- Functions ---
        
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            const screenToShow = screens[screenName];
            screenToShow.classList.remove('hidden');
            screenToShow.classList.add('screen-fade-in');
            screenToShow.addEventListener('animationend', () => {
                screenToShow.classList.remove('screen-fade-in');
            }, { once: true });
        }

        function initializeUser() {
            const savedName = localStorage.getItem('quizUserName');
            loadGems();
            loadStats();
            if (savedName) {
                userName = savedName;
                welcomeTitleEl.textContent = `¬°Hola, ${userName}!`;
                showScreen('mainMenu');
            } else {
                showScreen('nameInput');
            }
        }

        function saveUserAndStart() {
            const name = nameInputEl.value.trim();
            if (name) {
                userName = name;
                localStorage.setItem('quizUserName', name);
                welcomeTitleEl.textContent = `¬°Hola, ${userName}!`;
                showScreen('mainMenu');
            } else {
                nameInputEl.classList.add('border-red-500');
            }
        }

        function loadGems() {
            const savedGems = localStorage.getItem('quizUserGems');
            gems = savedGems ? JSON.parse(savedGems) : {};
        }

        function saveGems() {
            localStorage.setItem('quizUserGems', JSON.stringify(gems));
        }

        function loadStats() {
            const savedStats = localStorage.getItem('quizUserStats');
            stats = savedStats ? JSON.parse(savedStats) : {};
        }

        function saveStats() {
            localStorage.setItem('quizUserStats', JSON.stringify(stats));
        }

        function updateStats(quizType, score, totalQuestions) {
            if (!stats[quizType]) {
                stats[quizType] = { correct: 0, total: 0 };
            }
            stats[quizType].correct += score;
            stats[quizType].total += totalQuestions;
            saveStats();
        }

        function showGemsScreen() {
            gemsContainerEl.innerHTML = '';
            const subjects = {
                'Matem√°ticas': ['multiplication', 'addition', 'subtraction', 'division'],
                'Espa√±ol': ['reading'],
                'Ingl√©s': ['english']
            };

            for (const subject in subjects) {
                const subjectDiv = document.createElement('div');
                subjectDiv.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-2">${subject}</h2>`;
                
                let hasGemsForSubject = false;
                subjects[subject].forEach(type => {
                    if (gems[type]) {
                        hasGemsForSubject = true;
                        const typeDiv = document.createElement('div');
                        typeDiv.className = 'ml-4 mb-4';
                        typeDiv.innerHTML = `<h3 class="font-semibold text-lg">${quizSettings[type].name}</h3>`;
                        
                        Object.keys(gems[type]).forEach(level => {
                            const levelGems = gems[type][level];
                            if(levelGems.diamonds > 0 || levelGems.rubies > 0) {
                                const levelDiv = document.createElement('div');
                                levelDiv.className = 'ml-4 text-gray-700';
                                levelDiv.innerHTML = `
                                    <p>${quizSettings[type].difficulties[level].name}:</p>
                                    <div class="flex justify-between items-center text-md ml-4"><span>üíé Diamantes:</span><span class="font-bold text-xl">${levelGems.diamonds}</span></div>
                                    <div class="flex justify-between items-center text-md ml-4"><span>üî¥ Rub√≠es:</span><span class="font-bold text-xl">${levelGems.rubies}</span></div>
                                `;
                                typeDiv.appendChild(levelDiv);
                            }
                        });
                        subjectDiv.appendChild(typeDiv);
                    }
                });
                if(hasGemsForSubject) {
                    gemsContainerEl.appendChild(subjectDiv);
                }
            }
            if (gemsContainerEl.innerHTML === '') {
                gemsContainerEl.innerHTML = '<p class="text-center text-gray-500">A√∫n no has ganado ninguna recompensa. ¬°Sigue jugando para conseguirlas!</p>';
            }
            showScreen('gems');
        }

        function showStatsScreen() {
            statsContainerEl.innerHTML = '';
            let hasStats = false;
            for (const type in stats) {
                if (stats[type] && stats[type].total > 0) {
                    hasStats = true;
                    const percentage = Math.round((stats[type].correct / stats[type].total) * 100);
                    const color = percentage > 75 ? 'bg-green-500' : percentage > 50 ? 'bg-yellow-500' : 'bg-red-500';
                    const statDiv = document.createElement('div');
                    statDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">${quizSettings[type].name}</span>
                            <span class="font-bold">${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="${color} h-4 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm text-gray-500 text-right">${stats[type].correct} / ${stats[type].total} correctas</p>
                    `;
                    statsContainerEl.appendChild(statDiv);
                }
            }
            if (!hasStats) {
                statsContainerEl.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay estad√≠sticas. ¬°Completa una sesi√≥n para ver tu progreso!</p>';
            }
            showScreen('stats');
        }

        function awardGem(quizType, difficultyKey, gemType) {
            if (!difficultyKey) return;
            if (!gems[quizType]) gems[quizType] = {};
            if (!gems[quizType][difficultyKey]) gems[quizType][difficultyKey] = { diamonds: 0, rubies: 0 };
            
            gems[quizType][difficultyKey][gemType]++;
            saveGems();
            
            if (gemType === 'diamonds') {
                checkGrandPrize();
            }
        }

        function checkGrandPrize() {
            const grandPrizeAwarded = localStorage.getItem('grandPrizeAwarded');
            if (grandPrizeAwarded) return;
            
            let hasEasy = false, hasNormal = false, hasHard = false;
            for(const type in gems) {
                if(gems[type].easy && gems[type].easy.diamonds > 0) hasEasy = true;
                if(gems[type].normal && gems[type].normal.diamonds > 0) hasNormal = true;
                if(gems[type].hard && gems[type].hard.diamonds > 0) hasHard = true;
            }

            if (hasEasy && hasNormal && hasHard) {
                document.querySelectorAll('.user-name-placeholder').forEach(el => el.textContent = userName);
                screens.prizeAlert.classList.remove('hidden');
                localStorage.setItem('grandPrizeAwarded', 'true');
            }
        }
        
        function selectQuizType(type) {
            currentQuizType = type;
            if (currentQuizType === 'reading') {
                difficultySettings = null; // No difficulty for reading
                startSession();
            } else {
                difficultyTitle.textContent = quizSettings[type].name;
                
                difficultyButtonsContainer.innerHTML = '';
                const levels = quizSettings[type].difficulties;
                const gradients = {
                    easy: 'from-green-500 to-emerald-600',
                    normal: 'from-yellow-500 to-amber-600',
                    hard: 'from-red-500 to-rose-600'
                };
                Object.keys(levels).forEach(level => {
                    const button = document.createElement('button');
                    button.dataset.difficulty = level;
                    button.className = `w-full bg-gradient-to-br ${gradients[level]} text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300`;
                    button.textContent = levels[level].name;
                    button.addEventListener('click', () => selectDifficulty(level));
                    difficultyButtonsContainer.appendChild(button);
                });

                showScreen('difficulty');
            }
        }
        
        function selectDifficulty(level) {
            difficultySettings = { ...quizSettings[currentQuizType].difficulties[level], key: level };
            startSession();
        }

        function startSession() {
            totalScore = 0;
            currentRound = 1;
            sessionContent = [];

            if (currentQuizType === 'english') {
                TOTAL_ROUNDS = 3;
                QUESTIONS_PER_ROUND = 10;
                const data = difficultySettings.data;
                let allWords = Object.keys(data);
                for (let i = allWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
                }
                const totalQuestionsNeeded = QUESTIONS_PER_ROUND * TOTAL_ROUNDS;
                sessionContent = allWords.slice(0, totalQuestionsNeeded);
            } else if (currentQuizType === 'reading') {
                sessionContent = [...readingData].sort(() => Math.random() - 0.5);
                TOTAL_ROUNDS = sessionContent.length;
                QUESTIONS_PER_ROUND = sessionContent[0].questions.length;
            } else if (currentQuizType === 'division' && difficultySettings.name.includes('Visual')) {
                TOTAL_ROUNDS = 3;
                QUESTIONS_PER_ROUND = 5; 
            }
             else {
                TOTAL_ROUNDS = 3;
                QUESTIONS_PER_ROUND = 10;
            }
            startRound();
        }
        
        function startRound() {
            score = 0;
            currentQuestionIndex = 0;
            generateQuestions();

            if (currentQuizType === 'reading') {
                setupReadingScreen();
            } else if (currentQuizType === 'division' && difficultySettings.name.includes('Visual')) {
                showNextDivisionGame();
            }
            else {
                showScreen('quiz');
                showNextQuestion();
            }
        }
        
        function setupReadingScreen() {
            const reading = sessionContent[currentRound - 1];
            readingTitleEl.textContent = reading.title;
            
            const words = reading.text.split(' ');
            readingTextContainerEl.innerHTML = words.map(word => `<span>${word} </span>`).join('');
            
            const wordCount = words.length;
            const timeInSeconds = Math.round((wordCount / reading.wpm) * 60);
            readingTimerEl.textContent = `${timeInSeconds}s`;
            
            startReadingBtn.style.display = 'block';
            pauseResumeBtn.style.display = 'none';

            startReadingBtn.onclick = () => {
                startReadingBtn.style.display = 'none';
                pauseResumeBtn.style.display = 'block';
                startKaraoke(words, timeInSeconds);
            };
            
            showScreen('reading');
        }
        
        let wordIndex = 0;
        let timePerWord = 0;

        function startKaraoke(words, totalTime) {
            wordIndex = 0;
            timeLeft = totalTime;
            timePerWord = (totalTime * 1000) / words.length;
            isReadingPaused = false;
            
            pauseResumeBtn.textContent = 'Pausar';
            resumeKaraoke();
        }

        function resumeKaraoke() {
            const wordSpans = readingTextContainerEl.querySelectorAll('span');
            
            readingTimerInterval = setInterval(() => {
                timeLeft--;
                readingTimerEl.textContent = `${timeLeft}s`;
                if (timeLeft <= 0) clearInterval(readingTimerInterval);
            }, 1000);

            function highlightNext() {
                if (wordIndex > 0) wordSpans[wordIndex - 1].classList.remove('reading-highlight');
                
                if (wordIndex < wordSpans.length) {
                    wordSpans[wordIndex].classList.add('reading-highlight');
                    wordSpans[wordIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    wordIndex++;
                } else {
                    clearInterval(karaokeInterval);
                    clearInterval(readingTimerInterval);
                    setTimeout(() => {
                        showScreen('quiz');
                        showNextQuestion();
                    }, 1000);
                }
            }
            
            karaokeInterval = setInterval(highlightNext, timePerWord);
            highlightNext();
        }

        function pauseKaraoke() {
            clearInterval(karaokeInterval);
            clearInterval(readingTimerInterval);
        }

        function generateQuestions() {
            questions = [];
            if (currentQuizType === 'english') {
                const data = difficultySettings.data;
                const startIndex = (currentRound - 1) * QUESTIONS_PER_ROUND;
                const endIndex = startIndex + QUESTIONS_PER_ROUND;
                const roundWords = sessionContent.slice(startIndex, endIndex);

                questions = roundWords.map(word => ({
                    text: `¬øC√≥mo se dice "${word}"?`,
                    answer: data[word]
                }));
            } else if (currentQuizType === 'reading') {
                const reading = sessionContent[currentRound - 1];
                questions = reading.questions.map(q => ({
                    text: q.q,
                    answer: q.a,
                    options: [...q.o, q.a].sort(() => Math.random() - 0.5)
                }));
            } else if (currentQuizType === 'division') {
                for (let i = 0; i < QUESTIONS_PER_ROUND; i++) {
                    questions.push(generateDivisionQuestion());
                }
            }
             else {
                for (let i = 0; i < QUESTIONS_PER_ROUND; i++) {
                    questions.push(generateMathQuestion());
                }
            }
        }

        function generateMathQuestion() {
            let num1, num2, answer, text;
            const operator = { multiplication: '√ó', addition: '+', subtraction: '-'}[currentQuizType];
            
            if (currentQuizType === 'multiplication') {
                const { min, max } = difficultySettings.tables;
                num1 = getRandomNumber(min, max);
                num2 = getRandomNumber(1, 10);
                answer = num1 * num2;
            } else {
                const [min, max] = difficultySettings.range;
                num1 = getRandomNumber(min, max);
                num2 = getRandomNumber(min, max);
                if (currentQuizType === 'subtraction' && num1 < num2) [num1, num2] = [num2, num1];
                answer = currentQuizType === 'addition' ? num1 + num2 : num1 - num2;
            }
            text = `${num1} ${operator} ${num2} = ?`;
            return { text, answer };
        }
        
        function generateDivisionQuestion() {
            if (difficultySettings.name.includes('Normal')) {
                const num2 = getRandomNumber(2, 9);
                const result = getRandomNumber(2, 9);
                const num1 = num2 * result;
                return { text: `${num1} √∑ ${num2} = ?`, answer: result };
            } else { // Hard (with remainder)
                const divisor = getRandomNumber(2, 9);
                const quotient = getRandomNumber(2, 9);
                const remainder = getRandomNumber(1, divisor - 1);
                const dividend = divisor * quotient + remainder;
                return { text: `${dividend} √∑ ${divisor} = ?`, answer: `${quotient} sobra ${remainder}` };
            }
        }
        
        function showNextDivisionGame() {
            if (currentQuestionIndex < QUESTIONS_PER_ROUND) {
                setupDivisionVisualGame();
                showScreen('divisionVisual');
            } else {
                handleRoundEnd();
            }
        }

        function setupDivisionVisualGame() {
            divisionGameCounterEl.textContent = `Ronda ${currentRound} | Pregunta ${currentQuestionIndex + 1}/${QUESTIONS_PER_ROUND}`;
            const items = ['üçé', 'üéà', '‚≠ê', 'üéÅ', '‚öΩ'];
            const item = items[Math.floor(Math.random() * items.length)];
            const divisor = getRandomNumber(2, 4);
            const quotient = getRandomNumber(2, 4);
            const dividend = divisor * quotient;

            divisionGameInstructionEl.textContent = `Reparte ${dividend} ${item} entre ${divisor} grupos.`;
            
            itemsSourceContainerEl.innerHTML = '';
            for (let i = 0; i < dividend; i++) {
                const div = document.createElement('div');
                div.textContent = item;
                div.className = 'draggable-item text-3xl';
                div.draggable = true;
                div.addEventListener('dragstart', e => {
                    draggedItem = e.target;
                });
                itemsSourceContainerEl.appendChild(div);
            }

            dropTargetsContainerEl.innerHTML = '';
            dropTargetsContainerEl.className = `grid grid-cols-${divisor} gap-4 mb-4`;
            for (let i = 0; i < divisor; i++) {
                const div = document.createElement('div');
                div.className = 'drop-target h-24 border-2 border-dashed rounded-lg flex flex-wrap justify-center items-center gap-1 p-1';
                div.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.target.closest('.drop-target').classList.add('over');
                });
                div.addEventListener('dragleave', e => {
                    e.target.closest('.drop-target').classList.remove('over');
                });
                div.addEventListener('drop', e => {
                    e.preventDefault();
                    const target = e.target.closest('.drop-target');
                    target.classList.remove('over');
                    if (draggedItem) {
                        target.appendChild(draggedItem);
                        draggedItem = null;
                    }
                });
                dropTargetsContainerEl.appendChild(div);
            }
            
            divisionGameFeedbackEl.textContent = '';
            checkDivisionBtn.onclick = () => {
                let isCorrect = true;
                const targets = dropTargetsContainerEl.querySelectorAll('.drop-target');
                if (itemsSourceContainerEl.children.length > 0) isCorrect = false;

                targets.forEach(target => {
                    if (target.children.length !== quotient) {
                        isCorrect = false;
                    }
                });

                if (isCorrect) {
                    score++;
                    divisionGameFeedbackEl.textContent = `¬°Correcto! ${dividend} √∑ ${divisor} = ${quotient}`;
                    divisionGameFeedbackEl.classList.add('text-green-500');
                    divisionGameFeedbackEl.classList.remove('text-red-500');
                    currentQuestionIndex++;
                    setTimeout(showNextDivisionGame, 2000);
                } else {
                    divisionGameFeedbackEl.textContent = 'Int√©ntalo de nuevo.';
                    divisionGameFeedbackEl.classList.add('text-red-500');
                    divisionGameFeedbackEl.classList.remove('text-green-500');
                }
            };
        }

        function showNextQuestion() {
            resetState();
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                questionCounterEl.textContent = `Ronda ${currentRound} | Pregunta ${currentQuestionIndex + 1}/${questions.length}`;
                scoreEl.textContent = `Puntaje: ${score}`;
                questionTextEl.textContent = question.text;

                const options = question.options || generateOptions(question.answer);
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('btn-answer', 'w-full', 'bg-gray-50', 'border-2', 'border-gray-200', 'text-gray-700', 'font-semibold', 'py-4', 'px-2', 'rounded-lg', 'hover:bg-white', 'hover:border-indigo-400', 'hover:shadow-md', 'focus:outline-none', 'transition-all', 'duration-200', 'text-xl');
                    button.dataset.answer = option;
                    button.addEventListener('click', handleAnswerSelection);
                    answersContainer.appendChild(button);
                });
                
                if (currentQuizType !== 'reading') {
                    screens.quiz.querySelector('#timer-container').style.display = 'block';
                    startTimer();
                } else {
                    screens.quiz.querySelector('#timer-container').style.display = 'none';
                }
            } else {
                handleRoundEnd();
            }
        }
        
        function handleRoundEnd() {
            totalScore += score;
            if (currentRound < TOTAL_ROUNDS) {
                const motivationalMessages = [
                    `¬°√Ånimo, ${userName}! Los campeones no se rinden. ¬°La pr√≥xima ronda es tuya!`,
                    `¬°No te preocupes, ${userName}! Cada error es una oportunidad para aprender. ¬°Vamos!`,
                    `¬°Sigue adelante! Los desaf√≠os te hacen m√°s inteligente. ¬°A por la siguiente!`
                ];
                const goodJobMessages = [
                    `¬°Ronda ${currentRound} Completada!`,
                    `¬°Excelente trabajo, ${userName}!`,
                    `¬°Sigue as√≠, campe√≥n!`
                ];

                if (score < questions.length / 2) {
                    const message = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                    roundEndTitleEl.textContent = message;
                } else {
                    const message = goodJobMessages[Math.floor(Math.random() * goodJobMessages.length)];
                    roundEndTitleEl.textContent = message;
                }
                
                roundScoreEl.textContent = `Tu puntaje en esta ronda: ${score} de ${questions.length}`;
                showScreen('roundTransition');
            } else {
                showFinalScore();
            }
        }

        function generateOptions(correctAnswer) {
            const options = new Set([correctAnswer]);
            if (currentQuizType === 'english') {
                const allAnswers = Object.values(difficultySettings.data);
                while (options.size < 4 && options.size < allAnswers.length) {
                    const randomAnswer = allAnswers[getRandomNumber(0, allAnswers.length - 1)];
                    options.add(randomAnswer);
                }
            } else if (currentQuizType === 'reading') {
                while (options.size < 4 && options.size < questions[currentQuestionIndex].options.length) {
                    const randomOption = questions[currentQuestionIndex].options[getRandomNumber(0, questions[currentQuestionIndex].options.length - 1)];
                    options.add(randomOption);
                }
            }
            else if (currentQuizType === 'division' && typeof correctAnswer === 'string') { // Division with remainder
                while (options.size < 4) {
                    const [q, r] = correctAnswer.split(' sobra ').map(Number);
                    const wrongQ = q + (Math.random() < 0.5 ? -1 : 1);
                    const wrongR = r + (Math.random() < 0.5 ? -1 : 1);
                    if (wrongQ > 0) options.add(`${wrongQ} sobra ${r}`);
                    if (wrongR >= 0 && wrongR !== r) options.add(`${q} sobra ${wrongR}`);
                }
            }
            else {
                while (options.size < 4) {
                    let offset;
                    const randomFactor = Math.random() < 0.5 ? -1 : 1;
                    switch(difficultySettings.optionLogic) {
                        case 'wide': offset = (Math.floor(Math.random() * 8) + 3) * randomFactor; break;
                        case 'close': offset = (Math.floor(Math.random() * 2) + 1) * randomFactor; break;
                        default: offset = (Math.floor(Math.random() * 5) + 1) * randomFactor; break;
                    }
                    let wrongAnswer = correctAnswer + offset;
                    if (wrongAnswer >= 0 && wrongAnswer !== correctAnswer) {
                        options.add(wrongAnswer);
                    }
                }
            }
            return Array.from(options).sort(() => Math.random() - 0.5);
        }
        
        function resetState() {
            clearInterval(timer);
            clearInterval(readingTimerInterval);
            clearInterval(karaokeInterval);
            isReadingPaused = false;
            feedbackContainer.textContent = '';
            feedbackContainer.classList.remove('text-red-500', 'text-green-500');
            while (answersContainer.firstChild) {
                answersContainer.removeChild(answersContainer.firstChild);
            }
        }

        function handleAnswerSelection(e) {
            clearInterval(timer);
            const selectedButton = e.target;
            const selectedAnswer = typeof questions[currentQuestionIndex].answer === 'number'
                ? parseInt(selectedButton.dataset.answer, 10)
                : selectedButton.dataset.answer;
            const correctAnswer = questions[currentQuestionIndex].answer;
            showFeedback(selectedAnswer == correctAnswer, correctAnswer, selectedButton);
        }

        function handleTimeUp() {
            const correctAnswer = questions[currentQuestionIndex].answer;
            showFeedback(false, correctAnswer);
        }
        
        function showFeedback(isCorrect, correctAnswer, selectedButton = null) {
            Array.from(answersContainer.children).forEach(button => {
                button.disabled = true;
                const buttonAnswer = typeof correctAnswer === 'number' ? parseInt(button.dataset.answer, 10) : button.dataset.answer;
                if (buttonAnswer == correctAnswer) button.classList.add('correct');
            });

            if (isCorrect) {
                score++;
                feedbackContainer.textContent = '¬°Correcto!';
                feedbackContainer.classList.add('text-green-500');
                if (selectedButton) selectedButton.classList.add('correct');
                
                if (currentQuizType === 'english' && englishVoice) {
                    const utterance = new SpeechSynthesisUtterance(correctAnswer);
                    utterance.voice = englishVoice;
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            } else {
                feedbackContainer.textContent = selectedButton ? `Incorrecto. La respuesta es ${correctAnswer}` : `¬°Tiempo! La respuesta es ${correctAnswer}`;
                feedbackContainer.classList.add('text-red-500');
                if (selectedButton) selectedButton.classList.add('incorrect');
            }
            
            scoreEl.textContent = `Puntaje: ${score}`;
            currentQuestionIndex++;
            setTimeout(showNextQuestion, 2000);
        }

        function startTimer() {
            timeLeft = difficultySettings.timeLimit;
            timerText.textContent = timeLeft;
            timerProgress.style.strokeDashoffset = 0;
            timerProgress.className = "stroke-current text-indigo-600";
            setCircleDashoffset();

            timer = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                setCircleDashoffset();

                if (timeLeft <= difficultySettings.timeLimit * 0.5) timerProgress.className = "stroke-current text-yellow-500";
                if (timeLeft <= difficultySettings.timeLimit * 0.25) timerProgress.className = "stroke-current text-red-500";

                if (timeLeft === 0) {
                    clearInterval(timer);
                    handleTimeUp();
                }
            }, 1000);
        }

        function setCircleDashoffset() {
            const timeFraction = timeLeft / difficultySettings.timeLimit;
            const dashoffset = (1 - timeFraction) * FULL_DASH_ARRAY;
            timerProgress.style.strokeDashoffset = dashoffset;
        }
        
        function showFinalScore() {
            showScreen('end');
            const totalPossibleScore = QUESTIONS_PER_ROUND * TOTAL_ROUNDS;
            updateStats(currentQuizType, totalScore, totalPossibleScore);
            const percentage = totalScore / totalPossibleScore;

            if (totalScore === totalPossibleScore && difficultySettings) {
                awardGem(currentQuizType, difficultySettings.key, 'diamonds');
                finalTitleEl.textContent = `¬°PERFECTO, ${userName}! üíé`;
                finalMotivationEl.textContent = "¬°Has ganado un Diamante por tu incre√≠ble desempe√±o!";
            } else if (percentage >= 0.8 && difficultySettings) {
                awardGem(currentQuizType, difficultySettings.key, 'rubies');
                finalTitleEl.textContent = `¬°EXCELENTE, ${userName}! üî¥`;
                finalMotivationEl.textContent = "¬°Casi perfecto! Has ganado un Rub√≠ por tu gran esfuerzo.";
            }
            else if (totalScore < totalPossibleScore * 0.6) {
                finalTitleEl.textContent = `¬°Gran Esfuerzo, ${userName}!`;
                finalMotivationEl.textContent = "Sigue practicando y ser√°s imparable. ¬°Cada d√≠a eres m√°s inteligente!";
            } else {
                finalTitleEl.textContent = `¬°Felicidades, ${userName}!`;
                finalMotivationEl.textContent = "¬°Todo tu esfuerzo est√° dando frutos! Est√°s m√°s que listo para la secundaria.";
            }

            finalScoreEl.textContent = `Tu puntaje total: ${totalScore} de ${totalPossibleScore}.`;
            summaryTextEl.textContent = `${quizSettings[currentQuizType].name}${difficultySettings ? ' - ' + difficultySettings.name : ''}`;
        }
        
        function handleSwipe(currentScreen) {
            if (touchStartX < 50 && touchEndX > touchStartX + 100) {
                if (currentScreen === 'difficulty') {
                    if (currentQuizType === 'english') {
                        showScreen('mainMenu');
                    } else {
                        showScreen('mathType');
                    }
                } else if (currentScreen === 'mathType' || currentScreen === 'spanishType') {
                    showScreen('mainMenu');
                }
            }
        }
        
        // --- Event Listeners ---
        startWithNameBtn.addEventListener('click', saveUserAndStart);
        nameInputEl.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') saveUserAndStart();
        });

        mathMenuBtn.addEventListener('click', () => showScreen('mathType'));
        spanishMenuBtn.addEventListener('click', () => showScreen('spanishType'));
        englishMenuBtn.addEventListener('click', (e) => selectQuizType(e.currentTarget.dataset.quizType));
        gemsMenuBtn.addEventListener('click', showGemsScreen);
        statsMenuBtn.addEventListener('click', showStatsScreen);
        backToMainFromGemsBtn.addEventListener('click', () => showScreen('mainMenu'));
        backToMainFromStatsBtn.addEventListener('click', () => showScreen('mainMenu'));
        closePrizeAlertBtn.addEventListener('click', () => screens.prizeAlert.classList.add('hidden'));

        [...mathTypeButtons, ...spanishTypeButtons].forEach(button => {
             button.addEventListener('click', (e) => selectQuizType(e.currentTarget.dataset.quizType));
        });

        backToMainMenuBtn.addEventListener('click', () => showScreen('mainMenu'));
        backToMainMenuBtn2.addEventListener('click', () => showScreen('mainMenu'));

        nextRoundBtn.addEventListener('click', () => {
            currentRound++;
            startRound();
        });
        
        exitSessionBtn.addEventListener('click', () => {
             welcomeTitleEl.textContent = `¬°Hola, ${userName}!`;
             showScreen('mainMenu');
        });

        backBtn.addEventListener('click', () => {
            if (['english'].includes(currentQuizType)) {
                showScreen('mainMenu');
            } else if (['reading'].includes(currentQuizType)) {
                showScreen('spanishType');
            } else {
                showScreen('mathType');
            }
        });

        backFromQuizBtn.addEventListener('click', () => {
            resetState();
            backBtn.click(); 
        });
        
        backFromDivisionGameBtn.addEventListener('click', () => {
            resetState();
            showScreen('difficulty');
        });

        backFromReadingBtn.addEventListener('click', () => {
            resetState();
            showScreen('spanishType');
        });
        
        pauseResumeBtn.addEventListener('click', () => {
            isReadingPaused = !isReadingPaused;
            if (isReadingPaused) {
                pauseKaraoke();
                pauseResumeBtn.textContent = 'Continuar';
            } else {
                resumeKaraoke();
                pauseResumeBtn.textContent = 'Pausar';
            }
        });

        restartBtn.addEventListener('click', () => {
            welcomeTitleEl.textContent = `¬°Hola, ${userName}!`;
            showScreen('mainMenu');
        });

        ['difficulty', 'mathType', 'spanishType'].forEach(screenId => {
            screens[screenId].addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            screens[screenId].addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe(screenId);
            });
        });

        // --- Speech Synthesis Loader ---
        function loadEnglishVoice() {
            const voices = window.speechSynthesis.getVoices();
            englishVoice = voices.find(voice => voice.lang === 'en-US') || voices.find(voice => voice.lang.startsWith('en'));
        }
        loadEnglishVoice();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadEnglishVoice;
        }

        // --- Initial Load ---
        initializeUser();
    </script>
</body>
</html>
